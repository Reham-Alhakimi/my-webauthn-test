<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¨ØµÙ…Ø©</title>
</head>
<body>
  <h2>Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¨ØµÙ…Ø© Ø£Ùˆ Ø§Ù„ÙˆØ¬Ù‡</h2>
  <button id="registerBtn">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</button>

  <script>
    async function base64UrlToBuffer(base64url) {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
      const str = atob(base64);
      const buffer = new Uint8Array(str.length);
      for (let i = 0; i < str.length; i++) {
        buffer[i] = str.charCodeAt(i);
      }
      return buffer.buffer;
    }

    async function registerDevice() {
      try {
        if (!window.PublicKeyCredential) {
          throw new Error("âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… WebAuthn");
        }

        console.log("ğŸ“¥ Ø·Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Flutter...");
        const optionsJson = await window.flutter_inappwebview.callHandler('getOptions');
        const options = JSON.parse(optionsJson);
        console.log("âœ… Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:", options);

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ArrayBuffer
        options.challenge = await base64UrlToBuffer(options.challenge);
        options.user.id = await base64UrlToBuffer(options.user.id);

        console.log("ğŸ§ª Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ credential...");
        const credential = await navigator.credentials.create({ publicKey: options });
        console.log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ credential:", credential);

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ JSON Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        const credentialJson = {
          id: credential.id,
          rawId: Array.from(new Uint8Array(credential.rawId)),
          response: {
            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
            attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
          },
          type: credential.type
        };

        console.log("ğŸ“¤ Ù†Ø±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ Flutter...");
        await window.flutter_inappwebview.callHandler('onRegisterSuccess', JSON.stringify(credentialJson));
        console.log("ğŸ‰ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
      } catch (error) {
        console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", error);
        window.flutter_inappwebview.callHandler('onRegisterError', error.toString());
      }
    }

    document.getElementById('registerBtn').addEventListener('click', () => {
      console.log("ğŸ–±ï¸ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
      registerDevice();
    });
  </script>
</body>
</html>
