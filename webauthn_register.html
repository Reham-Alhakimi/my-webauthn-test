<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>تسجيل الجهاز بالبصمة</title>
</head>
<body>
  <h2>اضغط لتسجيل الجهاز بالبصمة أو الوجه</h2>
  <button id="registerBtn">سجل الآن</button>

  <script>
    // تحويل Base64Url إلى ArrayBuffer
    function b64urlToBuf(b64url) {
      const pad = '='.repeat((4 - b64url.length % 4) % 4);
      const b64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const bin = atob(b64);
      return Uint8Array.from([...bin].map(c => c.charCodeAt(0))).buffer;
    }

    // تحويل ArrayBuffer إلى Base64Url
    function bufferToBase64url(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let b of bytes) {
        binary += String.fromCharCode(b);
      }
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // قراءة الخيارات والتوكن من الرابط
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    const optionsString = params.get('options');

    if (!optionsString || !token) {
      alert('❌ لا توجد بيانات كافية في الرابط');
      throw 'Missing data';
    }

    const options = JSON.parse(decodeURIComponent(optionsString));
    options.challenge = b64urlToBuf(options.challenge);
    options.user.id = b64urlToBuf(options.user.id);

    // دالة التسجيل
    async function register() {
      try {
        const cred = await navigator.credentials.create({ publicKey: options });

        const attestationResponse = {
          id: cred.id,
          rawId: cred.rawId, // بدون تحويل
          type: cred.type,
          extensions: cred.getClientExtensionResults?.(),
          response: {
            attestationObject: bufferToBase64url(cred.response.attestationObject),
            clientDataJSON: bufferToBase64url(cred.response.clientDataJSON),
            transports: cred.response.getTransports?.() || []
          }
        };

        const res = await fetch('https://api.experts-imb.com/api/devices/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ AttestationResponse: attestationResponse })
        });

        if (res.ok) {
          alert('✅ تم تسجيل الجهاز بنجاح');
        } else {
          const errorText = await res.text();
          alert('❌ فشل تسجيل الجهاز: ' + errorText);
        }

      } catch (e) {
        console.error('❌ خطأ أثناء التسجيل:', e);
        alert('❌ خطأ أثناء التسجيل: ' + e.message);
      }
    }

    document.getElementById('registerBtn').onclick = register;
  </script>
</body>
</html>
