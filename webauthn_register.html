<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¨ØµÙ…Ø©</title>
</head>
<body>
  <h2>Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¨ØµÙ…Ø© Ø£Ùˆ Ø§Ù„ÙˆØ¬Ù‡</h2>
  <button id="registerBtn">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</button>

  <script>
    // âœ… ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Base64Url Ø¥Ù„Ù‰ ArrayBuffer
    async function base64UrlToBuffer(base64url) {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
      const str = atob(base64);
      const buffer = new Uint8Array(str.length);
      for (let i = 0; i < str.length; i++) {
        buffer[i] = str.charCodeAt(i);
      }
      return buffer.buffer;
    }

    // âœ… Ø¯Ø§Ù„Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    function parseOptionsFromURL() {
      const params = new URLSearchParams(window.location.search);
      const optionsString = params.get("options");
      if (!optionsString) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
        throw new Error("Missing options in URL");
      }
      return JSON.parse(decodeURIComponent(optionsString));
    }

    // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    async function registerDevice() {
      try {
        const options = parseOptionsFromURL();

        console.log("âœ… Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", options);

        options.challenge = await base64UrlToBuffer(options.challenge);
        options.user.id = await base64UrlToBuffer(options.user.id);

        const credential = await navigator.credentials.create({ publicKey: options });

        const credentialJson = {
          id: credential.id,
          rawId: Array.from(new Uint8Array(credential.rawId)),
          response: {
            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
            attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
          },
          type: credential.type
        };

        console.log("ðŸŽ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ credential Ø¨Ù†Ø¬Ø§Ø­");

        // âœ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ JSON Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
        const response = await fetch('http://173.248.155.167:8080/api/devices/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjBlODgwM2Q4LWRhZDItNDEwMS05M2Y2LThkYTI4MTkxYzdkZSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJhcHAtYWRtaW4yIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoiQXBwVXNlciIsImV4cCI6MTc1MDc1NDM2MiwiaXNzIjoiQnl0ZUxpbmtBUEkiLCJhdWQiOiJodHRwOi8vMTczLjI0OC4xNTUuMTY3OjgwODAifQ.lBwyhejDkMW68rnN9Ci54K9_jz0Jm8kQvX-gMHlIzfI'
          },
          body: JSON.stringify(credentialJson)
        });

        if (response.ok) {
          alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­");
        } else {
          const text = await response.text();
          alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…: " + text);
        }
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", error);
        alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message);
      }
    }

    document.getElementById('registerBtn').addEventListener('click', registerDevice);
  </script>
</body>
</html>
